import{c as M,a7 as I,a6 as T,a5 as E,ac as D,j as e,ad as A,P as V,ae as B,a2 as P,af as K,T as $,r as y,u as L,Q as H,ag as G,E as J,a1 as W,X as Q}from"./index-DYCMOhyY.js";import{U as F,R as X}from"./RightSidebar-Dt0JKdQ8.js";import{S as Y}from"./star-lcAsu_-e.js";import{P as q}from"./paperclip-BEEJzDs_.js";import{S as O}from"./send-Jj4GcqD2.js";import"./core.esm-Dtb28RSd.js";import"./remindersService-D0e1lVE8.js";import"./DatePicker-BjEDCiA7.js";import"./circle-BzEKEX28.js";import"./grip-vertical-Cd79Tdtl.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]],ee=M("printer",Z);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],se=M("reply",te),R={getMessages:async()=>{const t=T.getCurrentUser();if(!t)return[];const{data:n,error:o}=await I.from("inbox_participants").select("conversation_id").eq("user_id",t.id);if(o||!n||n.length===0)return[];const h=n.map(l=>l.conversation_id),{data:w,error:p}=await I.from("inbox_messages").select(`
                *,
                inbox_conversations (
                    subject,
                    inbox_participants (
                        user_id
                    )
                )
            `).in("conversation_id",h).order("created_at",{ascending:!1});return p?(console.error("Error fetching messages:",p),[]):(w||[]).map(l=>{var g,v;let u="group";if(l.sender_id===t.id){const c=(((g=l.inbox_conversations)==null?void 0:g.inbox_participants)||[]).find(f=>f.user_id!==t.id);u=c?c.user_id:"group"}else u=t.id;return{id:l.id,conversationId:l.conversation_id,senderId:l.sender_id,recipientId:u,subject:((v=l.inbox_conversations)==null?void 0:v.subject)||"(No Subject)",content:l.content,preview:l.content.substring(0,50)+"...",timestamp:l.created_at,isRead:!1,tags:[],attachments:l.attachments||[],tasks:[],notes:[]}})},markMessageRead:async t=>{var o;const{data:n}=await I.from("inbox_messages").select("conversation_id").eq("id",t).single();n&&T.getCurrentUser()&&await I.from("inbox_participants").update({is_read:!0}).eq("conversation_id",n.conversation_id).eq("user_id",(o=T.getCurrentUser())==null?void 0:o.id)},sendMessage:async(t,n,o,h=[],w)=>{const p=T.getCurrentUser();if(!p)throw new Error("Not logged in");let l=w;if(l)await I.from("inbox_conversations").update({last_message_preview:n.substring(0,50)}).eq("id",l),await I.from("inbox_participants").update({is_read:!1}).eq("conversation_id",l).neq("user_id",p.id);else{const{data:d,error:c}=await I.from("inbox_conversations").insert({subject:t,last_message_preview:n.substring(0,50),company_id:E()}).select().single();if(c)throw c;l=d.id;const f=[{conversation_id:l,user_id:p.id,is_read:!0,company_id:E()},{conversation_id:l,user_id:o,is_read:!1,company_id:E()}],{error:j}=await I.from("inbox_participants").insert(f);if(j)throw j}const u={conversation_id:l,sender_id:p.id,content:n,attachments:h,company_id:E()},{data:g,error:v}=await I.from("inbox_messages").insert(u).select().single();if(v)throw v;return{id:g.id,conversationId:l,senderId:g.sender_id,recipientId:o,subject:t,content:g.content,preview:g.content.substring(0,50),timestamp:g.created_at,isRead:!0,tags:[],attachments:g.attachments||[],tasks:[],notes:[]}},deleteMessage:async t=>{await I.from("inbox_messages").delete().eq("id",t)},updateMessage:async(t,n)=>{const o={};if(n.attachments&&(o.attachments=n.attachments),n.content&&(o.content=n.content),n.tags&&(o.tags=n.tags),n.snoozedUntil&&(o.snoozed_until=n.snoozedUntil),n.tasks&&(o.tasks=n.tasks),n.notes&&(o.notes=n.notes),Object.keys(o).length>0){const{error:h}=await I.from("inbox_messages").update(o).eq("id",t);h&&console.error("Error updating message:",h)}typeof n.isRead<"u"&&await R.markMessageRead(t)}},ae=({isLoading:t,messages:n,selectedId:o,filter:h,currentUser:w,onLoadMessages:p,onSetFilter:l,onSelectMessage:u,onDeleteMessage:g,onOpenCompose:v,users:d=[]})=>{const c=n.filter(m=>h==="inbox"?!m.tags.includes("archived"):m.senderId===w.id),f=m=>F[m]||{name:"Unknown",color:"#999",avatar:"?"},j=m=>{const C=new Date(m),r=new Date;return C.toDateString()===r.toDateString()?C.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):C.toLocaleDateString([],{month:"short",day:"numeric"})},[S,_]=D.useState(null),x=(m,C)=>{m.stopPropagation(),_(C)},N=()=>{S&&(g==null||g(S),_(null))};return e.jsxs("div",{className:"w-64 bg-stone-50/50 border-r border-stone-200 flex flex-col h-full",children:[e.jsxs("div",{className:"h-14 flex items-center justify-between px-4 border-b border-gray-100 flex-shrink-0 bg-stone-50/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"font-bold text-gray-800",children:"Inbox"}),c.filter(m=>!m.isRead&&m.recipientId===w.id).length>0&&e.jsx("span",{className:"px-1.5 py-0.5 bg-black text-white text-[10px] font-bold rounded-full",children:c.filter(m=>!m.isRead&&m.recipientId===w.id).length})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("button",{className:"p-1 hover:bg-gray-200 rounded-md text-gray-500 transition-colors",onClick:p,title:"Refresh",children:e.jsx(A,{size:16,className:t?"animate-spin":""})}),e.jsx("button",{onClick:v,className:"p-1 hover:bg-gray-200 rounded-md text-gray-500 transition-colors",title:"Compose",children:e.jsx(V,{size:18})})]})]}),e.jsx("div",{className:"p-4 pb-2",children:e.jsxs("div",{className:"relative group",children:[e.jsx(B,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 group-focus-within:text-black transition-colors",size:16}),e.jsx("input",{type:"text",placeholder:"Search messages...",className:"w-full pl-9 pr-4 py-2 bg-white border border-gray-200 focus:border-black focus:ring-0 rounded-xl text-sm transition-all placeholder-gray-500"})]})}),e.jsx("div",{className:"px-4 pb-2",children:e.jsxs("div",{className:"flex p-1 bg-gray-200/50 rounded-lg",children:[e.jsx("button",{onClick:()=>l("inbox"),className:`flex-1 py-1 text-xs font-semibold rounded-md transition-all duration-200 ${h==="inbox"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"Inbox"}),e.jsx("button",{onClick:()=>l("sent"),className:`flex-1 py-1 text-xs font-semibold rounded-md transition-all duration-200 ${h==="sent"?"bg-white text-gray-900 shadow-sm":"text-gray-500 hover:text-gray-700"}`,children:"Sent"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto custom-scrollbar px-2 pb-2 space-y-0.5",children:t&&n.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-32 text-gray-400 space-y-2",children:[e.jsx(A,{className:"animate-spin",size:20}),e.jsx("span",{className:"text-xs font-medium",children:"Syncing..."})]}):(()=>{const m=n.reduce((r,b)=>{if(h==="inbox"?!b.tags.includes("archived"):b.senderId===w.id){const s=b.conversationId||b.id;r[s]||(r[s]=[]),r[s].push(b)}return r},{}),C=Object.keys(m).sort((r,b)=>{const a=m[r].sort((i,k)=>new Date(k.timestamp).getTime()-new Date(i.timestamp).getTime())[0],s=m[b].sort((i,k)=>new Date(k.timestamp).getTime()-new Date(i.timestamp).getTime())[0];return new Date(s.timestamp).getTime()-new Date(a.timestamp).getTime()});return C.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-48 text-gray-400 space-y-2",children:[e.jsx(P,{size:32,className:"opacity-20"}),e.jsx("span",{className:"text-sm font-medium",children:"All caught up"})]}):C.map(r=>e.jsx(re,{convId:r,messages:m[r],selectedId:o,filter:h,currentUser:w,onSelectMessage:u,onDeleteClick:x,getSender:f,formatDate:j},r))})()}),e.jsx(K,{isOpen:!!S,onClose:()=>_(null),onConfirm:N,title:"Delete Message",message:"Are you sure you want to delete this message? This action cannot be undone.",confirmText:"Delete",variant:"danger"})]})},re=({convId:t,messages:n,selectedId:o,filter:h,currentUser:w,onSelectMessage:p,onDeleteClick:l,getSender:u,formatDate:g})=>{const v=n.sort((x,N)=>new Date(N.timestamp).getTime()-new Date(x.timestamp).getTime()),d=v[0],c=v.slice(1),f=u(d.senderId);o===d.id||c.some(x=>x.id===o);const j=h==="sent"?"#1e2126":f.color,[S,_]=D.useState(!1);return D.useEffect(()=>{c.some(x=>x.id===o)&&_(!0)},[o,c]),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{onClick:()=>p(d.id),className:`group relative py-2 px-3 rounded-lg cursor-pointer transition-all duration-200 border ${o===d.id?"bg-white border-gray-200 shadow-sm ring-1 ring-black/5":"bg-transparent border-transparent hover:bg-white/60 hover:border-gray-100"}`,children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs("div",{className:"relative flex-shrink-0 mt-0.5 flex flex-col items-center gap-1",children:[e.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-[10px] font-bold text-white shadow-sm ring-2 ring-white overflow-hidden",style:{backgroundColor:f.avatar.startsWith("/")?"transparent":j},children:f.avatar.startsWith("/")?e.jsx("img",{src:f.avatar,alt:f.name,className:"w-full h-full object-cover"}):f.avatar}),c.length>0&&e.jsx("button",{onClick:x=>{x.stopPropagation(),_(!S)},className:"p-0.5 hover:bg-gray-200 rounded-sm text-gray-400 hover:text-gray-600 transition-colors mt-0.5",children:S?e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"m18 15-6-6-6 6"})}):e.jsx("svg",{width:"10",height:"10",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("path",{d:"m6 9 6 6 6-6"})})}),!d.isRead&&h==="inbox"&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-2 h-2 bg-blue-500 border-2 border-white rounded-full ring-1 ring-blue-500/20"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-baseline mb-0.5",children:[e.jsxs("span",{className:`text-xs truncate pr-2 ${d.isRead?"font-semibold text-gray-700":"font-bold text-gray-900"}`,children:[d.subject,c.length>0&&e.jsxs("span",{className:"ml-1 text-[10px] text-gray-400 font-normal",children:["(",c.length+1,")"]})]}),e.jsx("span",{className:`text-[10px] flex-shrink-0 ${d.isRead?"text-gray-400":"text-blue-600 font-medium"}`,children:g(d.timestamp)})]}),e.jsx("div",{className:"text-[10px] text-gray-400 truncate leading-relaxed",children:d.preview})]})]}),e.jsx("button",{className:"absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 p-1 transition-all z-10 hover:scale-110",onClick:x=>l(x,d.id),title:"Delete",children:e.jsx($,{size:11,color:"#1e2126"})})]}),S&&c.map(x=>{const N=o===x.id,m=u(x.senderId);return e.jsxs("div",{onClick:()=>p(x.id),className:`ml-6 pl-4 py-1.5 pr-2 mb-0.5 rounded-r-lg border-l-2 cursor-pointer transition-all ${N?"bg-white border-l-blue-500 shadow-sm":"bg-stone-100/50 border-l-stone-300 hover:bg-stone-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-baseline",children:[e.jsx("span",{className:`text-[11px] truncate pr-2 ${N?"font-semibold text-gray-900":"text-gray-600"}`,children:m.name}),e.jsx("span",{className:"text-[9px] text-gray-400",children:g(x.timestamp)})]}),e.jsx("div",{className:"text-[10px] text-gray-400 truncate",children:x.preview})]},x.id)})]})},ne=({selectedMessage:t,threadMessages:n=[],currentUser:o,replyText:h,onReplyChange:w,onSendReply:p,onOpenCompose:l,onUpdateMessage:u,users:g=[]})=>{const d=[...n.length>0?n:t?[t]:[]].sort((a,s)=>new Date(a.timestamp).getTime()-new Date(s.timestamp).getTime()),c=a=>{const s=g.find(i=>i.id===a);return s?{name:s.name,color:s.color||"#999",avatar:s.avatarUrl||s.avatar||"?"}:F[a]||{name:"Unknown",color:"#999",avatar:"?"}},f=y.useRef(null),j=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2),S=async a=>{if(t&&a.target.files&&a.target.files[0]){const s=a.target.files[0],i={id:j(),name:s.name,type:s.type,url:URL.createObjectURL(s)},k=[...t.attachments||[],i];await R.updateMessage(t.id,{attachments:k}),u()}},{showToast:_}=L(),x=async()=>{if(!t)return;const a=t.tags.includes("starred"),s=a?t.tags.filter(i=>i!=="starred"):[...t.tags,"starred"];await R.updateMessage(t.id,{tags:s}),u(),_(a?"Message unstarred":"Message starred","success")},N=async()=>{if(!t)return;const a=new Date;a.setDate(a.getDate()+1),await R.updateMessage(t.id,{snoozedUntil:a.toISOString()}),u(),_("Message snoozed until tomorrow","success")},m=async()=>{t&&(await R.updateMessage(t.id,{isRead:!1}),u(),_("Marked as unread","success"))},C=()=>window.print(),r=y.useRef(null);D.useEffect(()=>{var a;(a=r.current)==null||a.scrollIntoView({behavior:"smooth"})},[d.length,t==null?void 0:t.id]);const b=y.useRef({});return D.useEffect(()=>{var a;t&&b.current[t.id]&&((a=b.current[t.id])==null||a.scrollIntoView({behavior:"smooth",block:"start"}))},[t==null?void 0:t.id]),e.jsx("div",{className:"flex-1 flex flex-col bg-white h-full min-w-0 relative z-0",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"h-14 border-b border-gray-200 flex items-center justify-between px-4 bg-white flex-shrink-0 sticky top-0 z-10",children:[e.jsx("div",{className:"flex items-center min-w-0",children:e.jsx("h1",{className:"text-lg font-bold text-gray-800 truncate mr-4",children:t.subject})}),e.jsx("div",{className:"flex items-center justify-between flex-shrink-0",children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("button",{onClick:x,className:`p-1.5 rounded-md transition-all ${t.tags.includes("starred")?"text-yellow-400 bg-yellow-50":"text-gray-400 hover:text-yellow-400 hover:bg-yellow-50"}`,title:"Star",children:e.jsx(Y,{size:18,fill:t.tags.includes("starred")?"currentColor":"none"})}),e.jsx("button",{onClick:N,className:`p-1.5 rounded-md transition-all ${t.snoozedUntil?"text-blue-500 bg-blue-50":"text-gray-400 hover:text-blue-500 hover:bg-blue-50"}`,title:"Snooze",children:e.jsx(H,{size:18})}),e.jsx("button",{onClick:m,className:"p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-all",title:"Mark as Unread",children:e.jsx(G,{size:18})}),e.jsx("button",{onClick:C,className:"p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-all",title:"Print",children:e.jsx(ee,{size:18})}),e.jsx("div",{className:"w-px h-4 bg-gray-200 mx-1"}),e.jsx("button",{className:"p-1.5 text-gray-400 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-all",title:"More options",children:e.jsx(J,{size:18})})]})})]}),e.jsxs("div",{className:"flex-1 flex min-h-0 bg-white",children:[e.jsxs("div",{className:"flex-1 flex flex-col min-w-0 relative overflow-hidden",children:[e.jsxs("div",{className:"flex-1 px-4 py-4 overflow-y-auto custom-scrollbar space-y-4",children:[d.map((a,s)=>{const i=c(a.senderId),k=a.senderId===o.id,z=t.id===a.id;return e.jsxs("div",{ref:U=>{b.current[a.id]=U},className:`border rounded-lg transition-all duration-300 overflow-hidden bg-white border-gray-200 shadow-sm ${z?"ring-2 ring-blue-500/20 shadow-md":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-100 bg-gray-50/30",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center text-[10px] font-bold text-white shadow-sm ring-2 ring-white overflow-hidden",style:{backgroundColor:i.avatar.startsWith("/")?"transparent":k?"#1e2126":i.color},children:i.avatar.startsWith("/")?e.jsx("img",{src:i.avatar,alt:i.name,className:"w-full h-full object-cover"}):i.avatar})}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"font-bold text-gray-900 text-sm truncate",children:i.name}),e.jsx("span",{className:"text-xs text-gray-400",children:new Date(a.timestamp).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"})})]})]}),e.jsx("div",{className:"flex items-center gap-2"})]}),e.jsxs("div",{className:"p-6",children:[e.jsx("div",{className:"text-sm text-gray-800 leading-relaxed whitespace-pre-wrap font-sans",children:a.content}),a.attachments&&a.attachments.length>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[e.jsx("h4",{className:"text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider",children:"Attachments"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:a.attachments.map(U=>e.jsxs("button",{className:"flex items-center p-2 bg-gray-50 border border-gray-200 rounded-lg text-xs hover:bg-gray-100 transition-colors group shadow-sm text-left",children:[e.jsx(W,{size:16,className:"text-blue-500 mr-2"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium text-gray-700 truncate max-w-[150px]",children:U.name}),e.jsxs("span",{className:"text-[10px] text-gray-400",children:[".",U.name.split(".").pop()]})]})]},U.id))})]})]})]},a.id)}),e.jsx("div",{ref:r,className:"h-1"})]}),e.jsx("div",{className:"p-6 bg-white border-t border-gray-100 z-10",children:e.jsxs("div",{className:"relative bg-white border border-gray-200 rounded-2xl shadow-sm focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-2 bg-gray-50/50 border-b border-gray-100 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-gray-400",children:[e.jsx(se,{size:14}),e.jsx("span",{className:"text-xs font-medium",children:"Replying to thread..."})]}),e.jsx("button",{className:"text-gray-400 hover:text-gray-600",children:e.jsx(q,{size:14,onClick:()=>{var a;return(a=f.current)==null?void 0:a.click()}})})]}),e.jsx("textarea",{className:"w-full p-4 min-h-[100px] focus:outline-none text-sm resize-none placeholder-gray-400",placeholder:"Write your reply...",value:h,onChange:a=>w(a.target.value),onKeyDown:a=>{a.key==="Enter"&&(a.metaKey||a.ctrlKey)&&p()}}),e.jsxs("div",{className:"px-4 py-3 bg-white flex justify-between items-center",children:[e.jsx("input",{type:"file",ref:f,className:"hidden",onChange:S}),e.jsx("div",{className:"text-xs text-gray-400 hidden sm:block",children:"Press Cmd+Enter to send"}),e.jsxs("button",{onClick:p,disabled:!h.trim(),className:"bg-black text-white px-6 py-2 rounded-xl text-sm font-semibold flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-800 hover:shadow-lg hover:-translate-y-0.5 transition-all",children:[e.jsx("span",{children:"Send Reply"}),e.jsx(O,{size:14})]})]})]})})]}),e.jsx(X,{contextId:t.id,className:"w-80 border-l border-gray-100 bg-gray-50/30 hidden lg:flex"})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:e.jsx(P,{size:32,className:"text-gray-300"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-2",children:"No Conversation Selected"}),e.jsx("p",{className:"max-w-xs text-center text-sm",children:"Select a conversation from the sidebar to view the thread."}),e.jsx("button",{onClick:l,className:"mt-6 px-4 py-2 bg-[#1e2126] text-white rounded-md text-sm font-medium hover:bg-[#2c3036] transition-colors",children:"Compose Message"})]})})},ie=({isOpen:t,onClose:n})=>{const o=y.useRef(null),[h,w]=y.useState(""),[p,l]=y.useState([]),[u,g]=y.useState(""),[v,d]=y.useState(""),[c,f]=y.useState(!1),[j,S]=y.useState([]),{showToast:_}=L(),x=T.getCurrentUser();y.useEffect(()=>{(async()=>{if(x)try{const a=(await T.getUsers()).filter(s=>s.id!=="me"&&s.id!==x.id);l(a),a.length>0&&!h&&w(a[0].id)}catch(b){console.error("Failed to load users",b)}})()},[x==null?void 0:x.id]);const N=async()=>{if(!(!u.trim()||!v.trim()||!h)){f(!0);try{await R.sendMessage(u,v,h,j),_("Message sent successfully","success"),n(),g(""),d(""),S([])}catch(r){console.error("Failed to send message",r),alert(`Error Sending Message: ${r.message||JSON.stringify(r)}`),_("Failed to send message","error")}finally{f(!1)}}},m=r=>{r.target.files&&r.target.files.length>0&&S([...j,...Array.from(r.target.files)])},C=r=>{S(j.filter((b,a)=>a!==r))};return t?e.jsxs("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 sm:p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity",onClick:n}),e.jsxs("div",{className:"relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-in fade-in zoom-in-95 duration-200",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-100",children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"New Message"}),e.jsx("button",{onClick:n,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Q,{size:20})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block text-xs font-bold uppercase tracking-wider text-gray-500 ml-1",children:"To"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"w-full appearance-none bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-gray-900 focus:outline-none focus:ring-2 focus:ring-black/5 focus:border-black transition-all cursor-pointer hover:bg-gray-100",value:h,onChange:r=>w(r.target.value),children:[p.map(r=>e.jsxs("option",{value:r.id,children:[r.name," (",r.email,")"]},r.id)),p.length===0&&e.jsx("option",{disabled:!0,children:"No other users found"})]}),e.jsx("div",{className:"absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-500",children:e.jsx("svg",{width:"10",height:"6",viewBox:"0 0 10 6",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M1 1L5 5L9 1",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block text-xs font-bold uppercase tracking-wider text-gray-500 ml-1",children:"Subject"}),e.jsx("input",{type:"text",className:"w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm font-medium text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-black/5 focus:border-black transition-all hover:bg-gray-100",placeholder:"What's this about?",value:u,onChange:r=>g(r.target.value)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"block text-xs font-bold uppercase tracking-wider text-gray-500 ml-1",children:"Message"}),e.jsx("textarea",{className:"w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-black/5 focus:border-black min-h-[200px] resize-none transition-all hover:bg-gray-100",placeholder:"Write your message...",value:v,onChange:r=>d(r.target.value)})]}),j.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-2",children:j.map((r,b)=>e.jsxs("div",{className:"flex items-center p-2 pl-3 bg-white border border-gray-200 rounded-lg text-xs group shadow-sm transition-all hover:border-gray-300",children:[e.jsx(W,{size:14,className:"text-blue-500 mr-2"}),e.jsx("span",{className:"text-gray-700 font-medium max-w-[150px] truncate",children:r.name}),e.jsx("button",{onClick:()=>C(b),className:"ml-2 text-gray-400 hover:text-red-500 p-1 rounded hover:bg-red-50 transition-colors",children:e.jsx($,{size:14})})]},b))})]}),e.jsxs("div",{className:"px-8 py-5 border-t border-gray-100 bg-white flex items-center justify-between sticky bottom-0 z-10",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"file",multiple:!0,ref:o,className:"hidden",onChange:m}),e.jsxs("button",{className:"text-gray-500 hover:text-gray-900 p-2.5 rounded-lg hover:bg-gray-100 transition-all flex items-center space-x-2 group",title:"Attach file",onClick:()=>{var r;return(r=o.current)==null?void 0:r.click()},children:[e.jsx(q,{size:20,className:"group-hover:-rotate-45 transition-transform duration-300"}),e.jsx("span",{className:"text-sm font-medium",children:"Attach"})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:n,className:"px-6 py-2.5 text-sm font-semibold text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-xl transition-all",children:"Cancel"}),e.jsx("button",{onClick:N,disabled:!u.trim()||!v.trim()||c,className:"px-8 py-2.5 text-sm font-bold bg-black text-white rounded-xl hover:bg-gray-800 hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none",children:c?"Sending...":e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"Send Message"}),e.jsx(O,{size:16,className:"ml-2"})]})})]})]})]})]}):null},fe=()=>{const[t,n]=y.useState([]),[o,h]=y.useState(null),[w,p]=y.useState(!0),[l,u]=y.useState(""),[g,v]=y.useState("inbox"),{showToast:d}=L(),c=T.getCurrentUser(),[f,j]=y.useState(!1),[S,_]=y.useState([]);if(!c)return e.jsx("div",{children:"Please log in"});y.useEffect(()=>{N(),x();const s=I.channel("inbox_updates").on("postgres_changes",{event:"*",schema:"public",table:"inbox_messages"},i=>{console.log("Message update received:",i),N(),i.eventType==="INSERT"&&d("New message","info")}).on("postgres_changes",{event:"*",schema:"public",table:"inbox_participants"},i=>{console.log("Participant update received:",i),i.new&&i.new.user_id===c.id&&(N(),d("New conversation","info"))}).subscribe(i=>{console.log("Inbox subscription status:",i)});return()=>{I.removeChannel(s)}},[]);const x=async()=>{const s=await T.getUsers();_(s)},N=async()=>{p(!0);try{const s=await R.getMessages();n(s.sort((i,k)=>new Date(k.timestamp).getTime()-new Date(i.timestamp).getTime()))}catch(s){console.error(s)}finally{p(!1)}},m=async s=>{h(s);const i=t.find(k=>k.id===s);i&&!i.isRead&&i.recipientId===c.id&&(n(k=>k.map(z=>z.id===s?{...z,isRead:!0}:z)),await R.markMessageRead(s))},C=async()=>{if(!l.trim())return;const s=t.find(z=>z.id===o);if(!s)return;console.log("Replying to message:",{id:s.id,conversationId:s.conversationId,subject:s.subject}),s.conversationId||console.warn("WARNING: Message missing conversationId. Reply will start a NEW conversation separate from this one.");const i=`Re: ${s.subject}`,k=s.senderId===c.id?s.recipientId:s.senderId;d("Sending...","info");try{await R.sendMessage(i,l,k,[],s.conversationId),u(""),d("Reply sent!","success"),N()}catch{d("Failed to send","error")}},r=t.find(s=>s.id===o),b=r?t.filter(s=>s.conversationId&&s.conversationId===r.conversationId||s.id===r.id):[],a=async s=>{try{await R.deleteMessage(s),n(i=>i.filter(k=>k.id!==s)),o===s&&h(null),d("Message deleted","success")}catch{d("Failed to delete message","error")}};return e.jsxs("div",{className:"flex h-full bg-transparent overflow-hidden animate-in fade-in duration-300 relative",children:[e.jsx(ae,{isLoading:w,messages:t,selectedId:o,filter:g,currentUser:{...c,email:c.email||""},onLoadMessages:N,onSetFilter:v,onSelectMessage:m,onDeleteMessage:a,onOpenCompose:()=>j(!0),users:S}),e.jsx(ne,{selectedMessage:r,threadMessages:b,currentUser:{...c,email:c.email||""},replyText:l,onReplyChange:u,onSendReply:C,onOpenCompose:()=>j(!0),onUpdateMessage:N,users:S}),f&&e.jsx(ie,{isOpen:f,onClose:()=>j(!1)})]})};export{fe as default};
